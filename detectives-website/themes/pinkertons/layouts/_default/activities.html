{{ define "main" }}
<section class="py-16 px-6">
  <div class="container mx-auto">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-4xl md:text-5xl font-heading font-bold text-grit-text-dark mb-4">{{ .Title }}</h1>
      <div class="text-xl text-grit-text-dark/80 mb-8">{{ .Content }}</div>

      <!-- Controls -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6 shadow-sm" x-data="activitiesTable()">
        <!-- Location Filter Banner -->
        <div x-show="locationName" class="mb-4 p-3 bg-grit-steel/10 border border-grit-steel/30 rounded-lg flex items-center justify-between">
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-grit-steel" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            <span class="text-grit-text-dark">Showing activities at: <strong x-text="locationName"></strong></span>
          </div>
          <a href="/activities/" class="text-sm text-grit-accent hover:text-grit-steel transition-colors">
            Clear location filter
          </a>
        </div>
        <!-- Search and Filter -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
          <div>
            <label class="block text-base font-medium text-grit-text-dark mb-2">Search</label>
            <input
              type="text"
              x-model="searchTerm"
              @input="filterActivities"
              placeholder="Search activities..."
              class="w-full px-4 py-2 bg-white border border-gray-300 rounded text-grit-text-dark focus:outline-none focus:border-grit-steel focus:ring-1 focus:ring-grit-steel"
            />
          </div>

          <div>
            <label class="block text-base font-medium text-grit-text-dark mb-2">Activity</label>
            <select
              x-model="activityFilter"
              @change="filterActivities"
              class="w-full px-4 py-2 bg-white border border-gray-300 rounded text-grit-text-dark focus:outline-none focus:border-grit-steel focus:ring-1 focus:ring-grit-steel"
            >
              <option value="">All Activities</option>
              <template x-for="activity in activityTypes" :key="activity">
                <option :value="activity" x-text="activity"></option>
              </template>
            </select>
          </div>

          <div>
            <label class="block text-base font-medium text-grit-text-dark mb-2">Operative</label>
            <select
              x-model="operativeFilter"
              @change="filterActivities"
              class="w-full px-4 py-2 bg-white border border-gray-300 rounded text-grit-text-dark focus:outline-none focus:border-grit-steel focus:ring-1 focus:ring-grit-steel"
            >
              <option value="">All Operatives</option>
              <template x-for="operative in operatives" :key="operative">
                <option :value="operative" x-text="operative"></option>
              </template>
            </select>
          </div>

          <div>
            <label class="block text-base font-medium text-grit-text-dark mb-2">Subject</label>
            <select
              x-model="subjectFilter"
              @change="filterActivities"
              class="w-full px-4 py-2 bg-white border border-gray-300 rounded text-grit-text-dark focus:outline-none focus:border-grit-steel focus:ring-1 focus:ring-grit-steel"
            >
              <option value="">All Subjects</option>
              <template x-for="subject in subjects" :key="subject">
                <option :value="subject" x-text="subject"></option>
              </template>
            </select>
          </div>
        </div>

        <div class="flex justify-between items-center text-base text-grit-text-dark/80">
          <div>
            Showing <span x-text="filteredActivities.length"></span> of <span x-text="allActivities.length"></span> activities
          </div>
          <button
            @click="clearFilters"
            class="px-4 py-2 bg-grit-accent hover:bg-grit-accent/90 text-white rounded transition-colors"
          >
            Clear Filters
          </button>
        </div>

        <!-- Loading Indicator -->
        <div x-show="loading" class="mt-4 text-center text-grit-text-dark/80">
          <p>Loading activities...</p>
        </div>

        <!-- Error Message -->
        <div x-show="error" class="mt-4 text-center text-grit-accent">
          <p x-text="errorMessage"></p>
        </div>

        <!-- Table -->
        <div class="mt-6 overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="border-b-2 border-gray-300 bg-gray-50">
                <th class="px-4 py-3 text-grit-steel font-heading text-sm uppercase whitespace-nowrap text-left">Date</th>
                <th class="px-4 py-3 text-grit-steel font-heading text-sm uppercase whitespace-nowrap text-left">Time</th>
                <th class="px-4 py-3 text-grit-steel font-heading text-sm uppercase text-left">Activity</th>
                <th class="px-4 py-3 text-grit-steel font-heading text-sm uppercase text-left">Subject</th>
                <th class="px-4 py-3 text-grit-steel font-heading text-sm uppercase text-left">Notes</th>
                <th class="px-4 py-3 text-grit-steel font-heading text-sm uppercase text-left">Operative</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="activity in paginatedActivities" :key="activity.id">
                <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                  <td class="px-4 py-3 text-grit-text-dark/80 text-base whitespace-nowrap" x-text="formatDate(activity.date)"></td>
                  <td class="px-4 py-3 text-grit-text-dark/80 text-base whitespace-nowrap" x-text="formatTime(activity.time)"></td>
                  <td class="px-4 py-3 text-grit-text-dark/80 text-base" x-text="activity.activity || 'N/A'"></td>
                  <td class="px-4 py-3 text-grit-text-dark/80 text-base" x-text="activity.subject || 'N/A'"></td>
                  <td class="px-4 py-3 text-grit-text-dark text-base" x-text="activity.activity_notes || 'N/A'"></td>
                  <td class="px-4 py-3 text-grit-text-dark/80 text-base" x-text="activity.operative || 'N/A'"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="mt-6 flex justify-between items-center">
          <button
            @click="previousPage"
            :disabled="currentPage === 1"
            :class="currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-grit-accent/90'"
            class="px-4 py-2 bg-grit-accent text-white rounded transition-colors"
          >
            Previous
          </button>

          <div class="text-grit-text-dark/80">
            Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span>
          </div>

          <button
            @click="nextPage"
            :disabled="currentPage === totalPages"
            :class="currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-grit-accent/90'"
            class="px-4 py-2 bg-grit-accent text-white rounded transition-colors"
          >
            Next
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  function activitiesTable() {
    return {
      allActivities: [],
      filteredActivities: [],
      searchTerm: '',
      activityFilter: '',
      activityTypes: [],
      operativeFilter: '',
      operatives: [],
      subjectFilter: '',
      subjects: [],
      locationIdFilter: null,
      locationName: null,
      currentPage: 1,
      itemsPerPage: 20,
      loading: true,
      error: false,
      errorMessage: '',

      get paginatedActivities() {
        const start = (this.currentPage - 1) * this.itemsPerPage;
        const end = start + this.itemsPerPage;
        return this.filteredActivities.slice(start, end);
      },

      get totalPages() {
        return Math.ceil(this.filteredActivities.length / this.itemsPerPage) || 1;
      },

      init() {
        // Read URL parameters for pre-filtering
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('search')) {
          this.searchTerm = urlParams.get('search');
        }
        if (urlParams.has('operative')) {
          this.operativeFilter = urlParams.get('operative');
        }
        if (urlParams.has('location_id')) {
          this.locationIdFilter = urlParams.get('location_id');
        }
        this.loadActivities();
      },

      async loadActivities() {
        try {
          // Build API URL with location_id filter if present
          let apiUrl = 'https://data.chnm.org/pinkertons/activities';
          if (this.locationIdFilter) {
            apiUrl += `?location_id=${this.locationIdFilter}`;
          }

          const response = await fetch(apiUrl);
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          const data = await response.json();
          this.allActivities = data;
          this.filteredActivities = data;
          this.loading = false;
          console.log(`Loaded ${data.length} activities`);

          // Extract unique activity types, operatives, and subjects from data
          const activitySet = new Set();
          const operativeSet = new Set();
          const subjectSet = new Set();
          data.forEach(a => {
            if (a.activity && a.activity.trim()) {
              activitySet.add(a.activity.trim());
            }
            if (a.operative && a.operative.trim()) {
              operativeSet.add(a.operative.trim());
            }
            if (a.subject && a.subject.trim()) {
              subjectSet.add(a.subject.trim());
            }
          });
          this.activityTypes = Array.from(activitySet).sort();
          this.operatives = Array.from(operativeSet).sort();
          this.subjects = Array.from(subjectSet).sort();

          // Extract location name from first activity if filtering by location
          if (this.locationIdFilter && data.length > 0 && data[0].locations) {
            const loc = Array.isArray(data[0].locations) ? data[0].locations[0] : data[0].locations;
            this.locationName = loc.location_name || loc.locality || null;
          }

          // Apply client-side filters if any were set from URL params
          if (this.searchTerm || this.operativeFilter) {
            this.filterActivities();
          }
        } catch (err) {
          this.loading = false;
          this.error = true;
          this.errorMessage = `Error loading activities: ${err.message}.`;
          console.error('Error fetching activities:', err);
        }
      },

      formatDate(dateString) {
        if (!dateString) return 'N/A';
        // Extract just the date part (yyyy-mm-dd) from various formats
        const dateMatch = dateString.match(/(\d{4}-\d{2}-\d{2})/);
        return dateMatch ? dateMatch[1] : dateString;
      },

      formatTime(timeString) {
        if (!timeString) return 'N/A';

        // Extract HH:MM:SS from formats like "12:00:00.000000" or "12:00:00"
        const timeMatch = timeString.match(/(\d{2}):(\d{2}):(\d{2})/);
        if (!timeMatch) return timeString;

        let hours = parseInt(timeMatch[1], 10);
        const minutes = timeMatch[2];
        const ampm = hours >= 12 ? 'PM' : 'AM';

        // Convert to 12-hour format
        hours = hours % 12;
        hours = hours ? hours : 12; // 0 should be 12

        return `${hours}:${minutes} ${ampm}`;
      },

      formatLocations(locations) {
        if (!locations || locations.length === 0) return 'N/A';

        return locations.map(loc => {
          const name = loc.location_name || loc.locality || 'Unknown';
          const visits = loc.visits ? ` <span class="text-xs text-grit-accent">(${loc.visits} visit${loc.visits !== 1 ? 's' : ''})</span>` : '';
          return `${name}${visits}`;
        }).join(', ');
      },

      filterActivities() {
        this.filteredActivities = this.allActivities.filter(activity => {
          // Search in locations array
          const locationMatch = activity.locations && activity.locations.some(loc =>
            (loc.location_name && loc.location_name.toLowerCase().includes(this.searchTerm.toLowerCase())) ||
            (loc.locality && loc.locality.toLowerCase().includes(this.searchTerm.toLowerCase())) ||
            (loc.location_type && loc.location_type.toLowerCase().includes(this.searchTerm.toLowerCase()))
          );

          const matchesSearch = !this.searchTerm ||
            (activity.activity_notes && activity.activity_notes.toLowerCase().includes(this.searchTerm.toLowerCase())) ||
            locationMatch ||
            (activity.activity && activity.activity.toLowerCase().includes(this.searchTerm.toLowerCase())) ||
            (activity.subject && activity.subject.toLowerCase().includes(this.searchTerm.toLowerCase()));

          const matchesActivity = !this.activityFilter ||
            (activity.activity && activity.activity.trim() === this.activityFilter);

          const matchesOperative = !this.operativeFilter ||
            (activity.operative && activity.operative.trim() === this.operativeFilter);

          const matchesSubject = !this.subjectFilter ||
            (activity.subject && activity.subject.trim() === this.subjectFilter);

          return matchesSearch && matchesActivity && matchesOperative && matchesSubject;
        });

        // Reset to first page when filtering
        this.currentPage = 1;
      },

      clearFilters() {
        // If filtering by location, redirect to clear server-side filter
        if (this.locationIdFilter) {
          window.location.href = '/activities/';
          return;
        }
        this.searchTerm = '';
        this.activityFilter = '';
        this.operativeFilter = '';
        this.subjectFilter = '';
        this.filterActivities();
      },

      nextPage() {
        if (this.currentPage < this.totalPages) {
          this.currentPage++;
        }
      },

      previousPage() {
        if (this.currentPage > 1) {
          this.currentPage--;
        }
      }
    };
  }
</script>
{{ end }}
