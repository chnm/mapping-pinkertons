{{ define "main" }}
<!-- Full viewport map container -->
<div class="fixed left-0 right-0 top-[57px] bottom-0 bg-gray-900" x-data="mapInterface()">

  <!-- Mobile Backdrop Overlay -->
  <div
    x-show="activePanel !== null || sidebarOpen"
    x-transition:enter="transition-opacity ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition-opacity ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    @click="closePanel(); closeSidebar();"
    class="fixed inset-0 bg-black/50 z-[1080] md:hidden"
    style="display: none;">
  </div>

  <!-- Icon Sidebar (Always Visible) -->
  <div class="absolute left-0 top-0 bottom-0 w-12 md:w-16 bg-grit-bg z-[1100] flex flex-col items-center py-3 md:py-4 space-y-4 md:space-y-6">
    <!-- Home/About Icon -->
    <button
      @click="togglePanel('home')"
      :class="activePanel === 'home' ? 'bg-grit-accent text-white' : 'text-grit-gold hover:bg-grit-steel/30'"
      class="w-8 h-8 md:w-10 md:h-10 rounded-lg flex items-center justify-center transition-colors"
      title="Mapping Surveillance">
      <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
      </svg>
    </button>

    <!-- View Mode Icon -->
    <button
      @click="togglePanel('viewMode')"
      :class="activePanel === 'viewMode' ? 'bg-grit-accent text-white' : 'text-grit-gold hover:bg-grit-steel/30'"
      class="w-8 h-8 md:w-10 md:h-10 rounded-lg flex items-center justify-center transition-colors"
      title="View Modes">
      <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
      </svg>
    </button>

    <!-- Locations Icon -->
    <button
      @click="togglePanel('locations')"
      :class="activePanel === 'locations' ? 'bg-grit-accent text-white' : 'text-grit-gold hover:bg-grit-steel/30'"
      class="w-8 h-8 md:w-10 md:h-10 rounded-lg flex items-center justify-center transition-colors"
      title="Locations">
      <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
      </svg>
    </button>

    <!-- Basemap Icon -->
    <button
      @click="togglePanel('basemap')"
      :class="activePanel === 'basemap' ? 'bg-grit-accent text-white' : 'text-grit-gold hover:bg-grit-steel/30'"
      class="w-8 h-8 md:w-10 md:h-10 rounded-lg flex items-center justify-center transition-colors"
      title="Map Layers">
      <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
      </svg>
    </button>
  </div>

  <!-- Slide-out Panel -->
  <div
    x-show="activePanel !== null"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="-translate-x-full"
    x-transition:enter-end="translate-x-0"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="translate-x-0"
    x-transition:leave-end="-translate-x-full"
    class="absolute left-12 md:left-16 top-0 bottom-0 w-[280px] md:w-80 bg-grit-bg border-r border-grit-steel z-[1090] flex flex-col shadow-xl"
    style="display: none;">

    <!-- Panel Header -->
    <div class="px-4 md:px-5 py-3 md:py-4 border-b border-grit-steel flex items-center justify-between bg-grit-steel/20">
      <h2 class="text-base md:text-lg font-heading font-semibold text-grit-gold" x-text="panelTitle"></h2>
      <button @click="closePanel()" class="text-grit-text hover:text-grit-gold transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Panel Content -->
    <div class="flex-1 overflow-y-auto px-4 md:px-5 py-3 md:py-4">

      <!-- Home/About Panel -->
      <div x-show="activePanel === 'home'" style="display: none;">
        <div class="space-y-3 md:space-y-4 text-grit-text">
          <div>
            <h3 class="text-base md:text-lg font-semibold text-grit-gold mb-2">About This Map</h3>
            <p class="text-sm md:text-base leading-relaxed">
              This interactive map visualizes the activities of Pinkerton detectives across the United States. Each marker represents locations where detective work was conducted, including surveillance, investigations, and other operations.
            </p>
          </div>

          <div>
            <h3 class="text-base md:text-lg font-semibold text-grit-gold mb-2">How to Use</h3>
            <ul class="text-sm md:text-base space-y-1.5 md:space-y-2">
              <li class="flex items-start">
                <svg class="w-4 h-4 text-grit-accent mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span><strong>Click markers</strong> to view detailed activity information for that location</span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-grit-accent mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span><strong>Use the view mode</strong> icon to switch between different visualization modes</span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-grit-accent mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span><strong>Zoom and pan</strong> the map explore details</span>
              </li>
              <li class="flex items-start">
                <svg class="w-4 h-4 text-grit-accent mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span><strong>Marker sizes</strong> indicate the number of visits to that location</span>
              </li>
            </ul>
          </div>

          <div>
            <h3 class="text-base md:text-lg font-semibold text-grit-gold mb-2">Data Sources</h3>
            <p class="text-sm md:text-base leading-relaxed">
              The data comes from historical Pinkerton detective reports and operational records. Each activity record includes information about dates, operatives, subjects, and the nature of investigations.
            </p>
          </div>

          <!-- Credits and Logos -->
          <div class="pt-4 mt-4 border-t border-grit-steel">
            <p class="text-sm md:text-base text-grit-text leading-relaxed mb-4">
              Developed by the
              <a class="text-white underline hover:no-underline transition-colors" href="https://rrchnm.org/" target="_blank" rel="noopener noreferrer">
                Roy Rosenzweig Center for History and New Media
              </a> at
              <a class="text-white underline hover:no-underline transition-colors" href="https://www.gmu.edu/" target="_blank" rel="noopener noreferrer">
                George Mason University
              </a>.
            </p>
            <div class="flex space-x-4 items-center pb-4">
              <img class="h-10 w-auto opacity-80 hover:opacity-100 transition-opacity"
                   src="/images/rrchnm-logo.png"
                   alt="Roy Rosenzweig Center for History and New Media" />
            </div>
            <div class="flex space-x-4 items-center">
              <img class="h-14 w-auto opacity-80 hover:opacity-100 transition-opacity"
                   src="/images/gmu-logo.png"
                   alt="George Mason University" />
            </div>
          </div>
        </div>
      </div>

      <!-- View Mode Panel -->
      <div x-show="activePanel === 'viewMode'" style="display: none;">
        <div class="space-y-2 md:space-y-3">

          <!-- All Activities Mode -->
          <button
            @click="setViewMode('all')"
            :class="viewMode === 'all' ? 'bg-grit-accent/20 border-grit-accent' : 'border-grit-steel/50 hover:border-grit-steel'"
            class="w-full text-left p-3 md:p-4 rounded-lg border-2 transition-all group">
            <div class="flex items-center justify-between mb-1.5 md:mb-2">
              <h3 class="text-sm md:text-base font-semibold text-grit-gold group-hover:text-white transition-colors">All Activities</h3>
              <svg x-show="viewMode === 'all'" class="w-4 h-4 md:w-5 md:h-5 text-grit-accent" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            </div>
            <p class="text-sm md:text-base text-grit-text/80 leading-relaxed">
              View all detective activities grouped by location. Marker size indicates the number of visits to each location, helping identify areas of concentrated activity.
            </p>
          </button>

          <!-- Investigation Types Mode -->
          <button
            @click="setViewMode('types')"
            :class="viewMode === 'types' ? 'bg-grit-accent/20 border-grit-accent' : 'border-grit-steel/50 hover:border-grit-steel'"
            class="w-full text-left p-3 md:p-4 rounded-lg border-2 transition-all group">
            <div class="flex items-center justify-between mb-1.5 md:mb-2">
              <h3 class="text-sm md:text-base font-semibold text-grit-gold group-hover:text-white transition-colors">Investigation Types</h3>
              <svg x-show="viewMode === 'types'" class="w-4 h-4 md:w-5 md:h-5 text-grit-accent" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            </div>
            <p class="text-sm md:text-base text-grit-text/80 leading-relaxed mb-2 md:mb-3">
              Color-coded view showing different types of locations visited during investigations. Each color represents a category such as businesses, residences, transportation hubs, and more.
            </p>

            <!-- Legend (visible in types mode) -->
            <div x-show="viewMode === 'types'" class="pt-3 border-t border-grit-steel/50">
              <div class="text-sm font-medium text-grit-gold mb-2">Legend:</div>
              <div class="grid grid-cols-1 gap-1.5 text-sm">
                <template x-for="category in locationCategories" :key="category.type">
                  <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full flex-shrink-0" :style="`background-color: ${category.color}`"></div>
                    <span class="text-grit-text/90" x-text="category.label"></span>
                  </div>
                </template>
              </div>
            </div>
          </button>

        </div>
      </div>

      <!-- Locations Panel -->
      <div x-show="activePanel === 'locations'" style="display: none;">
        <div class="space-y-2 md:space-y-3">

          <!-- Location: El Paso -->
          <button
            @click="setLocation('el-paso')"
            :class="selectedLocation === 'el-paso' ? 'bg-grit-accent/20 border-grit-accent' : 'border-grit-steel/50 hover:border-grit-steel'"
            class="w-full text-left p-3 md:p-4 rounded-lg border-2 transition-all group">
            <div class="flex items-center justify-between mb-1.5 md:mb-2">
              <h3 class="text-sm md:text-base font-semibold text-grit-gold group-hover:text-white transition-colors">El Paso, Texas</h3>
              <svg x-show="selectedLocation === 'el-paso'" class="w-4 h-4 md:w-5 md:h-5 text-grit-accent" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            </div>
            <p class="text-sm md:text-base text-grit-text/80 leading-relaxed">
              View Pinkerton detective activities in El Paso, a key border city where surveillance operations focused on labor disputes, border crossing activities, and investigations into suspected radicals.
            </p>
            <div class="mt-2 text-sm text-grit-text/60">
              <span x-text="activityCount"></span> activities recorded
            </div>
          </button>

          <!-- Placeholder for future locations -->
          <div class="p-3 md:p-4 rounded-lg border-2 border-grit-steel/30 bg-grit-steel/10">
            <p class="text-sm md:text-base text-grit-text/60 italic">
              Additional locations coming soon.
            </p>
          </div>

        </div>
      </div>

      <!-- Basemap Panel -->
      <div x-show="activePanel === 'basemap'" style="display: none;">
        <div class="space-y-2 md:space-y-3">

          <!-- Dark Map (current default) -->
          <button
            @click="setBasemap('dark')"
            :class="selectedBasemap === 'dark' ? 'bg-grit-accent/20 border-grit-accent' : 'border-grit-steel/50 hover:border-grit-steel'"
            class="w-full text-left p-3 md:p-4 rounded-lg border-2 transition-all group">
            <div class="flex items-center justify-between mb-1.5 md:mb-2">
              <h3 class="text-sm md:text-base font-semibold text-grit-gold group-hover:text-white transition-colors">Dark Map</h3>
              <svg x-show="selectedBasemap === 'dark'" class="w-4 h-4 md:w-5 md:h-5 text-grit-accent" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            </div>
            <p class="text-sm md:text-base text-grit-text/80 leading-relaxed">
              A dark themed map with street details and labels.
            </p>
          </button>

          <!-- Light Map -->
          <button
            @click="setBasemap('light')"
            :class="selectedBasemap === 'light' ? 'bg-grit-accent/20 border-grit-accent' : 'border-grit-steel/50 hover:border-grit-steel'"
            class="w-full text-left p-3 md:p-4 rounded-lg border-2 transition-all group">
            <div class="flex items-center justify-between mb-1.5 md:mb-2">
              <h3 class="text-sm md:text-base font-semibold text-grit-gold group-hover:text-white transition-colors">Light Map</h3>
              <svg x-show="selectedBasemap === 'light'" class="w-4 h-4 md:w-5 md:h-5 text-grit-accent" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            </div>
            <p class="text-sm md:text-base text-grit-text/80 leading-relaxed">
              A light-colored map with street details and labels.
            </p>
          </button>
          
          <!-- Placeholder for future historic maps -->
          <div class="p-3 md:p-4 rounded-lg border-2 border-grit-steel/30 bg-grit-steel/10">
            <p class="text-sm md:text-base text-grit-text/60 italic">
              Historic basemaps coming soon.
            </p>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- Map Container (fills remaining space) -->
  <div id="map" class="absolute left-12 md:left-16 right-0 top-0 bottom-0 z-[1000]"></div>

  <!-- Activity Details Sidebar (slides from right when marker clicked) -->
  <div
    x-show="sidebarOpen"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="translate-x-full"
    x-transition:enter-end="translate-x-0"
    x-transition:leave="transition ease-in duration-300"
    x-transition:leave-start="translate-x-0"
    x-transition:leave-end="translate-x-full"
    @keydown.escape.window="closeSidebar()"
    class="sidebar-panel"
    style="display: none;">
    <div class="sidebar-header">
      <div>
        <h2 class="text-xl md:text-2xl font-heading font-semibold text-grit-gold">
          <span x-text="sidebarTitle"></span>
        </h2>
        <div class="text-sm md:text-base text-grit-text/80 mt-1" x-show="locationVisits !== null">
          <span x-text="locationVisits"></span> <span x-text="locationVisits === 1 ? 'visit' : 'visits'"></span>
          <span class="mx-1">•</span>
          <span x-text="activities.length"></span> <span x-text="activities.length === 1 ? 'activity record' : 'activity records'"></span>
        </div>
      </div>
      <button @click="closeSidebar()" class="close-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div class="sidebar-content">
      <template x-if="activities.length === 0">
        <p class="text-grit-text/80 text-base">Click on a marker to view details</p>
      </template>

      <template x-for="activity in activities" :key="activity.id">
        <div class="activity-detail" :style="`border-left: 4px solid ${activity.border_color}`">
          <div class="flex items-baseline justify-between mb-3">
            <h4 class="text-lg md:text-xl font-semibold" x-text="activity.activity_notes || 'Activity'"></h4>
            <span class="text-base text-grit-text/60" x-show="activity.id" x-text="`#${activity.id}`"></span>
          </div>

          <div class="grid grid-cols-2 gap-x-3 gap-y-2 text-base">
            <template x-if="activity.formatted_date">
              <div class="col-span-2 activity-field-compact">
                <span class="activity-field-label">Date:</span>
                <span class="activity-field-value" x-text="activity.formatted_date"></span>
              </div>
            </template>

            <template x-if="activity.formatted_time">
              <div class="activity-field-compact">
                <span class="activity-field-label">Time:</span>
                <span class="activity-field-value" x-text="activity.formatted_time"></span>
              </div>
            </template>

            <template x-if="activity.duration">
              <div class="activity-field-compact">
                <span class="activity-field-label">Duration:</span>
                <span class="activity-field-value" x-text="activity.duration"></span>
              </div>
            </template>

            <template x-if="activity.location">
              <div class="col-span-2 activity-field-compact">
                <span class="activity-field-label">Location:</span>
                <span class="activity-field-value" x-text="activity.location"></span>
              </div>
            </template>

            <template x-if="activity.information_type">
              <div class="col-span-2 activity-field-compact">
                <span class="activity-field-label">Information Type:</span>
                <span class="activity-field-value" x-text="activity.information_type"></span>
              </div>
            </template>

            <template x-if="activity.location_category">
              <div class="col-span-2 activity-field-compact">
                <span class="activity-field-label">Category:</span>
                <span class="activity-field-value" x-text="activity.location_category"></span>
              </div>
            </template>

            <template x-if="activity.operative">
              <div class="col-span-2 activity-field-compact">
                <span class="activity-field-label">Operative:</span>
                <span class="activity-field-value" x-text="activity.operative"></span>
              </div>
            </template>

            <template x-if="activity.subject">
              <div class="col-span-2 activity-field-compact">
                <span class="activity-field-label">Subject:</span>
                <span class="activity-field-value" x-text="activity.subject"></span>
              </div>
            </template>

            <template x-if="activity.source">
              <div class="col-span-2 activity-field-compact">
                <span class="activity-field-label">Source:</span>
                <span class="activity-field-value" x-text="activity.source"></span>
              </div>
            </template>

            <template x-if="activity.roping">
              <div class="col-span-2 activity-field-compact">
                <span class="activity-field-label">Roping:</span>
                <span class="activity-field-value" x-text="activity.roping"></span>
              </div>
            </template>

            <template x-if="activity.mode">
              <div class="activity-field-compact">
                <span class="activity-field-label">Mode:</span>
                <span class="activity-field-value" x-text="activity.mode"></span>
              </div>
            </template>

            <template x-if="activity.edit_type">
              <div class="activity-field-compact">
                <span class="activity-field-label">Edit Type:</span>
                <span class="activity-field-value" x-text="activity.edit_type"></span>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div id="loading" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center text-white z-[1050]">
    <div class="bg-grit-bg/90 backdrop-blur-sm px-6 py-4 rounded-lg border border-grit-steel">
      <p>Loading map data...</p>
    </div>
  </div>

  <!-- Error Message -->
  <div id="error" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center z-[1050] hidden">
    <div class="bg-grit-bg/90 backdrop-blur-sm px-6 py-4 rounded-lg border border-grit-accent">
      <p class="text-grit-accent"></p>
    </div>
  </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>

<!-- Custom Map Styles -->
<style>
  /* Activity Details Sidebar */
  .sidebar-panel {
    position: absolute;
    top: 0;
    right: 0;
    width: 100%;
    max-width: 450px;
    bottom: 0;
    background-color: #1c1f22;
    border-left: 2px solid rgba(68, 105, 125, 0.3);
    z-index: 1110;
    display: flex;
    flex-direction: column;
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.3);
  }

  @media (min-width: 768px) {
    .sidebar-panel {
      max-width: 450px;
    }
  }

  @media (max-width: 767px) {
    .sidebar-panel {
      max-width: 85%;
    }
  }

  .sidebar-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid rgba(68, 105, 125, 0.3);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: rgba(68, 105, 125, 0.1);
  }

  @media (min-width: 768px) {
    .sidebar-header {
      padding: 1rem 1.25rem;
    }
  }

  .sidebar-content {
    padding: 0.75rem;
    overflow-y: auto;
    flex: 1;
    color: #f5f2e8;
  }

  @media (min-width: 768px) {
    .sidebar-content {
      padding: 1rem;
    }
  }

  .close-btn {
    background: none;
    border: none;
    color: #d0a85c;
    cursor: pointer;
    padding: 0.25rem;
    transition: color 0.2s;
    flex-shrink: 0;
  }

  .close-btn:hover {
    color: #f5f2e8;
  }

  .activity-detail {
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    padding-left: 0.75rem;
    border-bottom: 1px solid rgba(68, 105, 125, 0.2);
  }

  .activity-detail:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  .activity-detail h4 {
    font-family: 'Oswald', sans-serif;
    color: #d0a85c;
    line-height: 1.3;
  }

  .activity-field-compact {
    line-height: 1.6;
  }

  .activity-field-label {
    color: #d0a85c;
    font-weight: 600;
    display: inline-block;
    min-width: 80px;
  }

  .activity-field-value {
    color: rgba(245, 242, 232, 0.95);
  }

  /* Circle marker styles */
  .leaflet-interactive {
    cursor: pointer;
    transition: all 0.2s;
  }

  .leaflet-interactive:hover {
    fill-opacity: 0.9 !important;
    stroke-width: 2 !important;
  }

  .leaflet-interactive.selected {
    fill-opacity: 1 !important;
    stroke-width: 3 !important;
    stroke: #9c1b1b !important;
  }
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<script>
  // Initialize the map
  const map = L.map('map').setView([31.7619, -106.4850], 14); // Center on El Paso, TX

  // Define basemap layers
  const basemaps = {
    dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }),
    light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }),
    satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
      maxZoom: 19
    })
  };

  // Add default basemap (dark)
  let currentBasemap = basemaps.dark;
  currentBasemap.addTo(map);

  // Helper function to format date
  function formatDate(dateString) {
    if (!dateString) return null;
    const dateMatch = dateString.match(/(\d{4}-\d{2}-\d{2})/);
    return dateMatch ? dateMatch[1] : dateString;
  }

  // Helper function to format time to 12-hour format
  function formatTime(timeString) {
    if (!timeString) return null;

    // Extract HH:MM:SS from formats like "12:00:00.000000" or "12:00:00"
    const timeMatch = timeString.match(/(\d{2}):(\d{2}):(\d{2})/);
    if (!timeMatch) return timeString;

    let hours = parseInt(timeMatch[1], 10);
    const minutes = timeMatch[2];
    const ampm = hours >= 12 ? 'PM' : 'AM';

    // Convert to 12-hour format
    hours = hours % 12;
    hours = hours ? hours : 12; // 0 should be 12

    return `${hours}:${minutes} ${ampm}`;
  }

  // Define category mappings and colors
  const categoryColors = {
    'Bars, Theaters, Poolrooms': '#e74c3c',     // Red
    'Businesses': '#3498db',                      // Blue
    'Government & Organizations': '#2ecc71',      // Green
    'Neighborhoods & Parks': '#f39c12',           // Orange
    'Residence': '#9b59b6',                       // Purple
    'Roadways': '#1abc9c',                        // Turquoise
    'Taxi, Train, Bus': '#e67e22'                 // Carrot
  };

  // Map specific location types to categories
  const locationTypeMapping = {
    // Bars, Theaters, Poolrooms
    'Bar': 'Bars, Theaters, Poolrooms',
    'Poolroom': 'Bars, Theaters, Poolrooms',
    'Theater': 'Bars, Theaters, Poolrooms',

    // Businesses
    'Auto Wrecker': 'Businesses',
    'Automobile Dealership': 'Businesses',
    'Barber': 'Businesses',
    'Barber Shop': 'Businesses',
    'Café': 'Businesses',
    'Café?': 'Businesses',
    'Car Dealer': 'Businesses',
    'Dentist': 'Businesses',
    'Garage': 'Businesses',
    'Hotel': 'Businesses',
    'Office': 'Businesses',
    'Service Station': 'Businesses',
    'Store': 'Businesses',

    // Government & Organizations
    'Courthouse': 'Government & Organizations',
    'Post Office': 'Government & Organizations',
    'YMCA': 'Government & Organizations',

    // Neighborhoods & Parks
    'Neighborhood': 'Neighborhoods & Parks',
    'Park': 'Neighborhoods & Parks',
    'Zoo': 'Neighborhoods & Parks',

    // Residence
    'Apartment House': 'Residence',
    'Farm': 'Residence',
    'House': 'Residence',

    // Roadways
    'Bridge': 'Roadways',
    'Highway': 'Roadways',
    'Street': 'Roadways',

    // Taxi, Train, Bus
    'Bus Depot': 'Taxi, Train, Bus',
    'Bus stop': 'Taxi, Train, Bus',
    'Bus Stop': 'Taxi, Train, Bus',
    'Car': 'Taxi, Train, Bus',
    'Taxi stand': 'Taxi, Train, Bus',
    'Taxi Stand': 'Taxi, Train, Bus',
    'Train station': 'Taxi, Train, Bus',
    'Train Station': 'Taxi, Train, Bus'
  };

  // Helper function to get category for a location type
  function categorizeLocationType(locationType) {
    if (!locationType) return null;
    return locationTypeMapping[locationType] || null;
  }

  // Helper function to get color based on location type
  function getTypeColor(locationType) {
    const category = categorizeLocationType(locationType);
    return category ? categoryColors[category] : '#95a5a6'; // Gray for unmapped
  }

  // Get category label for a location type
  function getCategoryLabel(locationType) {
    return categorizeLocationType(locationType);
  }

  // Alpine.js component for map interface
  function mapInterface() {
    return {
      // Left panel controls
      activePanel: null,
      panelTitle: '',

      // Activity sidebar controls
      sidebarOpen: false,
      sidebarTitle: 'Activity Details',
      activities: [],
      locationVisits: null,
      selectedMarker: null,

      // View mode
      viewMode: 'all', // 'all' or 'types'
      groupedMarkers: [], // Grouped markers for "all" mode
      individualMarkers: [], // Individual markers for "types" mode
      locationCategories: [], // Dynamic categories from data

      // Location selection
      selectedLocation: 'el-paso',
      activityCount: 0,
      locations: {
        'el-paso': {
          name: 'El Paso, Texas',
          center: [31.7619, -106.4850],
          zoom: 14
        }
        // Future locations will be added here
      },

      // Basemap selection
      selectedBasemap: 'dark',

      init() {
        // Watch for viewMode changes and toggle marker sets
        this.$watch('viewMode', (newMode) => {
          this.toggleMarkerSets(newMode);
        });
      },

      // Left panel methods
      togglePanel(panel) {
        if (this.activePanel === panel) {
          this.closePanel();
        } else {
          this.activePanel = panel;
          if (panel === 'home') {
            this.panelTitle = 'Mapping Surveillance';
          } else if (panel === 'viewMode') {
            this.panelTitle = 'View Modes';
          } else if (panel === 'locations') {
            this.panelTitle = 'Select Location';
          } else if (panel === 'basemap') {
            this.panelTitle = 'Map Layers';
          }
        }
      },

      closePanel() {
        this.activePanel = null;
      },

      setViewMode(mode) {
        this.viewMode = mode;
        // Optionally close the panel after selection
        // this.closePanel();
      },

      setLocation(locationKey) {
        this.selectedLocation = locationKey;
        const location = this.locations[locationKey];
        if (location) {
          // Center and zoom the map to the selected location
          map.setView(location.center, location.zoom);
        }
        // Optionally close the panel after selection
        // this.closePanel();
      },

      setBasemap(basemapKey) {
        this.selectedBasemap = basemapKey;
        // Remove current basemap
        map.removeLayer(currentBasemap);
        // Add new basemap
        currentBasemap = basemaps[basemapKey];
        currentBasemap.addTo(map);
        // Optionally close the panel after selection
        // this.closePanel();
      },

      toggleMarkerSets(mode) {
        // Remove all markers from map first
        this.groupedMarkers.forEach(m => map.removeLayer(m.marker));
        this.individualMarkers.forEach(m => map.removeLayer(m.marker));

        // Add the appropriate marker set
        if (mode === 'types') {
          this.individualMarkers.forEach(m => m.marker.addTo(map));
        } else {
          this.groupedMarkers.forEach(m => m.marker.addTo(map));
        }

        // Close sidebar when switching modes
        this.closeSidebar();
      },

      buildLocationCategories() {
        // Build legend from the predefined categories
        const usedCategories = new Set();

        // Check which categories are actually in the data
        this.individualMarkers.forEach(markerData => {
          const category = categorizeLocationType(markerData.locationType);
          if (category) {
            usedCategories.add(category);
          }
        });

        // Build categories array in a specific order
        const categoryOrder = [
          'Bars, Theaters, Poolrooms',
          'Businesses',
          'Government & Organizations',
          'Neighborhoods & Parks',
          'Residence',
          'Roadways',
          'Taxi, Train, Bus'
        ];

        const categories = [];
        categoryOrder.forEach(categoryName => {
          if (usedCategories.has(categoryName)) {
            categories.push({
              type: categoryName,
              label: categoryName,
              color: categoryColors[categoryName]
            });
          }
        });

        this.locationCategories = categories;
      },

      openSidebar(activities, locationData = null) {
        // Sort activities by ID, then format dates and times
        const sortedActivities = [...activities].sort((a, b) => a.id - b.id);

        const formattedActivities = sortedActivities.map(activity => {
          // Extract location_type from nested locations array
          let locationType = null;
          if (activity.locations && Array.isArray(activity.locations) && activity.locations.length > 0) {
            locationType = activity.locations[0].location_type;
          } else if (activity.locations && typeof activity.locations === 'object') {
            locationType = activity.locations.location_type;
          }

          // Get the category and color for this location type
          const category = getCategoryLabel(locationType);
          const borderColor = getTypeColor(locationType);

          return {
            ...activity,
            formatted_date: formatDate(activity.date),
            formatted_time: formatTime(activity.time),
            location_type: locationType,
            location_category: category,
            border_color: borderColor
          };
        });

        // Get location name from first activity if available
        let locationName = 'Location Details';
        if (sortedActivities.length > 0 && sortedActivities[0].locations) {
          const loc = Array.isArray(sortedActivities[0].locations)
            ? sortedActivities[0].locations[0]
            : sortedActivities[0].locations;
          locationName = loc.location_name || loc.locality || 'Location Details';
        }

        this.sidebarTitle = locationName;
        this.activities = formattedActivities;
        this.locationVisits = locationData ? locationData.visits : null;
        this.sidebarOpen = true;
      },

      closeSidebar() {
        this.sidebarOpen = false;
        if (this.selectedMarker) {
          this.selectedMarker.getElement().classList.remove('selected');
          this.selectedMarker = null;
        }
      },

      setSelectedMarker(marker) {
        // Remove selected class from previous marker
        if (this.selectedMarker) {
          this.selectedMarker.getElement().classList.remove('selected');
        }
        // Add selected class to new marker
        marker.getElement().classList.add('selected');
        this.selectedMarker = marker;
      }
    };
  }

  // Fetch and display activities
  const loadingEl = document.getElementById('loading');
  const errorEl = document.getElementById('error');

  // Wait for Alpine to be fully initialized before fetching data
  document.addEventListener('alpine:init', () => {
    fetch('http://data.chnm.org/pinkertons/activities')
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {
      loadingEl.classList.add('hidden');

      // Create markers for activities with location data
      // Group activities by location_id to handle multiple activities at same location
      const locationMap = new Map();
      const markers = [];

      data.forEach((activity) => {
        // Check if locations field exists and has coordinates
        let lat = null;
        let lon = null;
        let locationType = null;
        let visits = null;
        let locationId = null;

        // First check if locations field exists (could be object or array)
        if (activity.locations) {
          if (Array.isArray(activity.locations) && activity.locations.length > 0) {
            // If it's an array, use the first location
            locationId = activity.locations[0].id;
            lat = activity.locations[0].latitude || activity.locations[0].lat;
            lon = activity.locations[0].longitude || activity.locations[0].lon;
            locationType = activity.locations[0].location_type;
            visits = (activity.locations[0].visits !== null && activity.locations[0].visits !== undefined)
              ? parseInt(activity.locations[0].visits, 10)
              : null;
          } else if (typeof activity.locations === 'object') {
            // If it's an object
            locationId = activity.locations.id;
            lat = activity.locations.latitude || activity.locations.lat;
            lon = activity.locations.longitude || activity.locations.lon;
            locationType = activity.locations.location_type;
            visits = (activity.locations.visits !== null && activity.locations.visits !== undefined)
              ? parseInt(activity.locations.visits, 10)
              : null;
          }
        }
        // Fallback to direct fields
        else {
          lat = activity.latitude || activity.lat;
          lon = activity.longitude || activity.lon;
        }

        if (lat && lon && locationId) {
          // Group by location_id instead of lat/lon
          if (!locationMap.has(locationId)) {
            locationMap.set(locationId, {
              locationId: locationId,
              lat: parseFloat(lat),
              lon: parseFloat(lon),
              activities: [],
              locationType: locationType,
              visits: visits !== null ? visits : null
            });
          }
          locationMap.get(locationId).activities.push(activity);
        }
      });

      // Get Alpine component instance for the map container
      const mapContainer = document.querySelector('[x-data="mapInterface()"]');
      const alpineData = Alpine.$data(mapContainer);

      // Helper function to add small jitter to coordinates
      function addJitter(coord, jitterAmount = 0.0003) {
        return coord + (Math.random() - 0.5) * jitterAmount;
      }

      // Track coordinates to detect overlaps and add jitter
      const coordCounts = new Map();
      locationMap.forEach((location) => {
        const coordKey = `${location.lat.toFixed(6)},${location.lon.toFixed(6)}`;
        coordCounts.set(coordKey, (coordCounts.get(coordKey) || 0) + 1);
      });

      // Create grouped markers (for "all" mode) and individual markers (for "types" mode)
      const groupedMarkers = [];
      const individualMarkers = [];

      // Create grouped markers for each unique location
      locationMap.forEach((location) => {
        // Use actual visits count, treating null/undefined as 0
        const visits = location.visits !== null && location.visits !== undefined ? location.visits : 0;
        // For 0 visits, use minimum size of 3, otherwise scale with sqrt
        const radius = visits > 0 ? (2 + Math.sqrt(visits) * 2) : 3;

        // Add jitter if multiple locations share these coordinates
        const coordKey = `${location.lat.toFixed(6)},${location.lon.toFixed(6)}`;
        const hasOverlap = coordCounts.get(coordKey) > 1;
        const lat = hasOverlap ? addJitter(location.lat) : location.lat;
        const lon = hasOverlap ? addJitter(location.lon) : location.lon;

        const marker = L.circleMarker([lat, lon], {
          radius: radius,
          fillColor: '#d0a85c',
          color: '#f5f2e8',
          weight: 1,
          opacity: 0.8,
          fillOpacity: 0.6
        });

        marker.on('click', function(e) {
          alpineData.setSelectedMarker(e.target);
          alpineData.openSidebar(location.activities, location);
        });

        groupedMarkers.push({
          marker: marker,
          locationData: location,
          type: 'grouped'
        });
      });

      // Create individual markers for each activity with jitter
      data.forEach((activity) => {
        let lat = null;
        let lon = null;
        let locationType = null;
        let visits = null;

        if (activity.locations) {
          if (Array.isArray(activity.locations) && activity.locations.length > 0) {
            lat = activity.locations[0].latitude || activity.locations[0].lat;
            lon = activity.locations[0].longitude || activity.locations[0].lon;
            locationType = activity.locations[0].location_type;
            visits = (activity.locations[0].visits !== null && activity.locations[0].visits !== undefined)
              ? parseInt(activity.locations[0].visits, 10)
              : null;
          } else if (typeof activity.locations === 'object') {
            lat = activity.locations.latitude || activity.locations.lat;
            lon = activity.locations.longitude || activity.locations.lon;
            locationType = activity.locations.location_type;
            visits = (activity.locations.visits !== null && activity.locations.visits !== undefined)
              ? parseInt(activity.locations.visits, 10)
              : null;
          }
        } else {
          lat = activity.latitude || activity.lat;
          lon = activity.longitude || activity.lon;
        }

        if (lat && lon) {
          // Add jitter to prevent exact overlaps
          const jitteredLat = addJitter(parseFloat(lat));
          const jitteredLon = addJitter(parseFloat(lon));

          const color = getTypeColor(locationType);

          const marker = L.circleMarker([jitteredLat, jitteredLon], {
            radius: 4,
            fillColor: color,
            color: '#f5f2e8',
            weight: 1,
            opacity: 0.8,
            fillOpacity: 0.7
          });

          marker.on('click', function(e) {
            alpineData.setSelectedMarker(e.target);
            // Pass minimal location data for individual markers
            const locationData = { visits: visits };
            alpineData.openSidebar([activity], locationData);
          });

          individualMarkers.push({
            marker: marker,
            activity: activity,
            locationType: locationType,
            type: 'individual'
          });
        }
      });

      // Store both marker sets in Alpine
      alpineData.groupedMarkers = groupedMarkers;
      alpineData.individualMarkers = individualMarkers;

      // Initially show grouped markers (default "all" mode)
      groupedMarkers.forEach(m => m.marker.addTo(map));
      markers.push(...groupedMarkers.map(m => m.marker));

      // Build the location categories for the legend
      alpineData.buildLocationCategories();

      // Set activity count for current location
      alpineData.activityCount = data.length;
    })
    .catch(error => {
      loadingEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
      errorEl.querySelector('p').textContent = `Error loading map data: ${error.message}.`;
      console.error('Error fetching activities:', error);
    });
  }); // End alpine:init event listener
</script>
{{ end }}
